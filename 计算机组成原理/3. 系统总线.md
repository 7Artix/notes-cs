
# 3.1 总线基本概念

计算机系统的互连方式有两种. 各部件之间使用单独的连线, 称为<font color=red><b>分散连接</b></font>, 将各部件链接到一组公共的信息传输线上, 称为<font color=red><b>总线连接</b></font>. 借由总线, 各个部件可以独立的增减.

通过总线相连时, 多个不见同时向总线发送信息会产生信号冲突, 导致传输无效, 因此某一时刻只能允许一个部件向总线发送信息, 但多个部件可以同时从总线上接受相同的信息.

若从CPU引出两条总线, `I/O总线`挂载各类I/O设备, `M总线`与主存连接, 该结构称为**双总线结构**. 对于双总线结构, I/O的数据要与内存传输需要经过CPU, 影响性能.

在**单总线结构**中, 所有部件全部连接到`系统总线`. 当主存与I/O传输信息时, CPU可以继续处理不依赖主存和I/O的操作. 但由于仅有一组总线, 因此当各个部件都需要占用总线时会引起冲突.

另外可以在**单总线结构**的基础上, 在CPU和主存之间增加一组`存储总线`, 提供主存与CPU之间的专用传输信息通道. 可以提高传输效率, 减轻系统总线的负载.


# 3.2 总线分类

按数据传输方式分类可分为:
- 并行总线
- 串行总线

按传输宽度可分为:
- 8位总线
- 16位总线
- 32位总线
- 64位总线
- ......

按使用范围划分可分为:
- 计算机总线
- 测控总线
- 网络通信总线
- ......

以下按连接部件不同, 介绍三类总线.


## 片内总线

片内总线是芯片内部的总线, 例如在CPU内部, 寄存器与寄存器之间, 寄存器算逻单元ALU之间, 均通过片内总线连接.


## 系统总线

系统总线是指CPU, 主存, I/O各大部件之间的总线. 也称为**板级总线**.

按传输信息的不同, 系统总线可分为:
- 数据总线
- 地址总线
- 控制总线

### 数据总线

用来传输各部件之间的信息, 是双向总线, 其位数与机器字长, 存储字长有关, 通常为8位, 16位, 32位.

### 地址总线

地址总线主要用于指出数据总线上的元数据或目的数据在主存单元的地址, 或I/O设备的地址. 地址总线由CPU单向输出.

### 控制总线

数据总线与地址总线是被挂载在总线上的所有部件共享的, 因此, 需要控制总线决定不同时刻, 不同部件的总线专用权. 
控制总线是用来发出各种控制信号的传输线. 
控制总线大致是由CPU发出控制指令的, 但是其余设备也可以通过控制总线想CPU发出中断请求, 总线占用请求等信息. 
控制总线还可以用于监视各设备状态.
因此, 控制总线是双向总线.

常见的控制信号包括:
- 时钟
- 复位
- 总线请求
- 总线允许
- 中断请求
- 中断响应
- 存储器读
- 存储器写
- I/O读
- I/O写
- 传输相应


# 3.3 总线特性及性能指标

### 总线性能指标

总线宽度: 数据总线的数量, 用bit表示

总线带宽: 总线的数据传输速率

时钟同步/异步

总线复用: 相同的信号线上分时传送多种信号. 例如可以使地址总线与数据总线共用相同的物理线路, 称为多路复用

信号线数: 地址总线, 数据总线, 控制总线三种总线数的和

总线控制方式: 突发工作, 自动配置, 仲裁方式, 逻辑方式, 计数方式等

其他指标: 负载能力, 电压, 总线宽度拓展性等.


# 南桥与北桥

南桥芯片与北桥芯片是芯片组中的两枚核心芯片, 构成了CPU与主板其他设备之间的通信枢纽.

北桥芯片是距离CPU最近的芯片, 主要负责处理系统中的高速信号. 北桥是CPU连接内存与高速总线的通道.

南桥通过北桥与CPU相连, 负责处理低速与周边信号, 进行外围设备的控制.

北桥的消失是由于很多关键组件被直接集成到了CPU内部.
北桥芯片是首先消失的.
负责与内存连接的内存控制器(MCU)被继承到了CPU内部, 使CPU可以直接访问内存, 提高了内存访问速度, 北桥失去了最核心的功能.
随着技术发展, 高速PCIe控制器也集成到了CPU内部.

南桥后续演变成现代主板上的芯片组.
在Intel Core平台上, PCH(Platform Controller Hub)即平台控制器中心通过DMI(Direct Media Interface)总线与CPU直接连接. DMI总线取代了传统的北桥-南桥通信路径, PCH 负责连接所有低速设备(如 SATA, USB, 音频, 网卡, 低速PCIe扩展槽等). DMI总线是类似PCIe总线的产物.
在AMD Ryzen平台上, 芯片组((Chipset)通过专用的PCIe总线通道连接到CPU.
在Apple Silicon以及其他主流移动或嵌入式SoC或MPU中不存在南桥芯片组. 全部控制器高度集成在一个芯片内.
MPU等ARM芯片的片内总线采用了ARM公司的**高级微控制器总线架构**(Advanced Microcontroller Bus Architecture, AMBA). 例如ACE, AXI, AHB, APB总线.

USB接口仍由南桥负责管理, 即使是20Gbps的USB接口, 控制器依然在芯片组内部, 通过DMI或PCIe链接到CPU.


# 总线标准

总线标准是系统与模块, 模块与模块之间互联的标准界面, 界面对两端模块透明, 界面的任一方只需根据总线标准的要求, 完成自身接口的功能要求, 无需了解对方接口与总线的连接要求.
按总线标准设计的接口可视为通用接口.

一些过时的总线: 
- ISA
- EISA
- VESA 局部总线, 在系统外围两个以上模块提供高速传输信息通道.
- AGP 加速图形端口, 专用显卡接口.

## UART & RS-232

RS-232描述了通信的电平范围, UART决定了帧结构, 校验和通信速率.
UART通用异步收发器. 其异步体现为没有时钟信号, 通过余弦设置好的波特率, 帧格式来进行通信.
UART进需要两根信号线便可实现双向通信.

## PCI

PCI总线: Peripheral Component Interconnect, 即外设组件互连标准. 有32-bit和64-bit, 以及3.3V和5V的PCI规格. 时钟频率与CPU时钟无关, 可采用33MHz和66MHz的总线时钟.
在66MHz的时钟频率下, 64-bit总线可达528MB/s的带宽. 
在PCI 3.0中取消了对5V设备的支持. PCI 3.0是PCI总线的最后一个版本.
支持突发工作方式, 即, 若被传送数据在主存中连续存储, 则访问该组数据是, 只需给出第一个数据地址, 后续数据传送不必给出地址.


## PCI-Express

GT/s和GB/s的区别类似于波特率和比特率.
GT/s和波特率, 衡量**物理层**的信号传输速度, 即每秒钟发送和接收的**原始信号脉冲数量**.
GB/s和比特率, 衡量**数据链路层及以上**的**有效数据吞吐量**, 即每秒钟实际传输的**用户数据量**.

PCI-Express可以支持热插拔.

常见的PCIe按通道数可分为`x1`, `x2`, `x4`, `x8`, `x16`.
每条Lane都可以进行双向的数据传输, 均为<font color=red><b>全双工</b></font>. 
PCIe 4.0的每通道传输速率是16 GT/s, x16传输带宽为31.508 GB/s(单向).
PCIe 5.0的每通道传输速率是32 GT/s, x16传输带宽为63.015 GB/s(单向).
代际提升为2倍关系.

PCIe是差分信号, 有一组参考时钟差分对. 每条Lane都有一对接收数据差分对以及一对发送数据差分对.

各类显卡, 网卡, 声卡, 硬盘等外设通常都使用PCIe总线连接.

主板上的PCIe插槽并非全部是CPU直连. 直连CPU的通常只有PCIe x16, 以及高速NVMe协议对应的M.2插槽.
PCIe x4, PCIe x1和额外的M.2/SATA通常通过南桥控制.

Thunderbolt倾向于高速直连的模式, 通过直连CPU的PCIe连接.


## USB

通用串行总线

``` bash
USB Host Root Hub
├──USB Device 1
└──USB Hub 1
    ├── USB Device 2
    └── USB Hub 2
	    ├── USB Hub 3
		│   ├── USB Device 3
		│	└── USB Device 4
        └── USB Hub 4
		 	└── USB Device 5
```

拓扑关系的最大深度为7.

从Root Hub到任何终端Device, 最多可以有5个Hub(不包括Root Hub). 最多可链式连接127个外设到同一系统, 该数量受寻址设备数限制.

单层本质上没有额外的设备数量限制, 但是若在同一层深度上连接过多的设备, 会在驱动时遇到严重的信号完整性问题.
此外, 将收发器全部集中在一层, 会导致设计困难.
通过Hub进行中继与重建, 可以对接收的衰减的信号进行**时钟恢复**, **抖动清除**, 提升稳定性.

USB Type-C

CC用于识别, SBU用于复用模式下的低速通信.

Type-C通过CC(Configuration channel) 识别从机设备, 并进行协议切换.
<font color=red><b>Thunderbolt</b></font>: 是基于PCIe的高速串行链路, 当从机识别为Thunderbolt, 该链路会同时承载3中数据流: PCIe, DP, USB. 即所有通信都会被封装到Thunderbolt中, 利用PCIe链路传输.
<font color=red><b>Display Port</b></font>: 当CC识别到 DP Alt Mode时, 高速差分信号线会分配给DP视频信号使用, 而USB2.0的两个信号线(D+, D-)会保留, 依然支持基础的USB通信. 如果4组差分对没有全部用完, 则可以建立USB 3.0/3.1连接.
<font color=red><b>Power Delivery</b></font>: 使用CC1或CC2进行供电协商. 当CC引脚未被影响时, PD可以与任意数据传输同步进行.
<font color=red><b>USB 3.0/3.1/3.2</b></font>: 使用2条或4条高速链路通信, 可选供电为: 5V 900mA, 5V 1.5A/3A 或通过USB-PD供电. 单通道模式下, 仅使用靠近CC引脚的差分对, 双通道模式下会使用全部4个差分对.
<font color=red><b>Debug Accessory Mode</b></font>: External Device Test System (DTS), 用于认证, 合规性测试, 以及调试等.
<font color=red><b>Audio Adapter Accessory Mode</b></font>: 在该模式下, 所有数字电路与连接器断开, 指定引脚用于模拟输入输出. D+和D-变为L, R声道, SBU变为AGND和MIC.


# 总线结构

总线结构通常分为单总线结构和多总线结构.
为了解决CPU, 主存, I/O设备之间传输速率不匹配, 并且解决总线占用问题, 需要采用多总线结构.
双总线结构将低速I/O设备从单总线上分离, 挂载在I/O总线上, 通过桥连接到主存总线.
一种三总线结构为:
- CPU与主存之间: 主存总线
- CPU与I/O之间: I/O总线
- 主存与I/O之间: DMA总线

另一种三总线结构为:
- CPU与Cache之间: 局部总线
- 主存, Cache, 拓展总线接口: 系统总线
- 其他外设: 拓展总线


# 总线控制

### 仲裁控制

总线上的设备分为:
- 主设备: 对总线有控制功能
- 从设备: 对总线无控制功能

从设备只能响应从主设备发送的总线命令, 而没有控制权.

只有主设备可以向总线控制器申请总线使用权. 从设备不需要申请使用权, 仅需在主设备选中时才参与数据传输.

若多个主设备同时申请使用总线, 需要总线控制器仲裁. 只有获得使用权的主设备才能控制总线.
总线仲裁分为集中式和分布式, 集中式的控制逻辑通常集中在CPU中, 分布式的控制逻辑分布在各个连接部件设备上.
常见的集中式仲裁方式包括:
- 链式查询: 总线同意信号串行经过各个设备, 距离控制器越近的设备具有越高的优先级, 当设备获取总线使用权时, 控制器输出总线忙信号.
- 计数器定时查询: 增加设备地址线, 当控制器接收到总线请求后, 通过地址线发出地址信号. 地址线通常为 $\log_2 n$ 根线, $n$ 取决于设备数量.
- 独立请求: 每一台设备均有一对总线请求和总线同意线.


### 通信控制

1个总线周期分为以下四个阶段:
1. 申请分配阶段: 主设备提出申请, 总线控制器仲裁决定下一传输周期的总线使用权.
2. 寻址阶段: 获得使用权的主设备通过总线发出要访问的从设备的地址及命令.
3. 传输阶段: 主设备和从设备通过总线进行数据交换.
4. 结束阶段: 主设备将信息撤出总线, 让出使用权.

对于仅有一个主设备的系统, 总线始终归其所有, 不需要申请, 分配, 以及撤除.

通信可以<font color=red><b>分时复用</b></font>或<font color=red><b>并行通信</b></font>. 
在地址/数据分时复用总线中, 需要先传地址, 后传数据. 常用于串行总线或早期并行总线.
在并行传输总线中, 同一时钟周期内, 地址信息更新于地址线上, 数据信息更新于数据线上.

数据的传输会有时间片机制, 在总线传输上会使用更精准的突发传输限制. 通常有抢占式和非抢占式:
- <font color=red><b>非抢占式</b></font> (Non-Preemptive): 优先级更高的设备必须等待当前主设备完成其整个突发传输或原子任务.
- <font color=red><b>抢占式</b></font> (Preemptive): 在复杂实时总线中, 高优先级设备可以中断低优先级设备的传输.

在通用计算机总线中, 为了保证数据完整性, 通常使用非抢占式, 只在突发传输的间隔点做切换.

总线通信控制主要解决通信双方如何获知传输开始和传输结束, 以及双方如何协调配合.
有如下常用通信方式:
1. <font color=red><b>同步通信</b></font>: 有统一时钟控制. 时钟通常由总线控制器发出, 也可以由各个设备发出.
2. <font color=red><b>异步通信</b></font>: 无同步时钟, 采用应答方式. 本质上, 异步通信无需应答, 采用固定波特率, 编码格式的方式也可以进行通信. 异步又有以下几种方式:
   - **不互锁**: 主设备发送请求信号后, 不等待从设备, 而是在确认从设备收到后就撤销请求信号, 而从设备在收到请求信号后发送回答信号, 确认主设备收到后撤销回答信号.
   - **半互锁**: 主设备的请求信号需要从设备响应, 从设备的回答信号不需要主设备响应.
   - **全互锁**: 主设备的请求信号和从设备的回答信号都需要对方响应.
3. <font color=red><b>分离式通信</b></font>: 将一个总线周期分解为两个子周期. 
   - 在第一子周期内, 主设备在获得总线使用权后, 将命令, 地址, 以及其他信息, 包含主设备编号发送至总线上, 由有关的从设备接受. 随机立刻放弃总线使用权.
   - 在第二子周期内, 从设备准备好相关的数据后, 申请总线使用权, 获取后, 将原本主设备的编号, 从设备地址, 目标数据等发送至总线. 在该周期中, 原本的从设备也充当了主设备的角色.

另外还有半同步通信, 是在同步通信的基础上增加了一个 $\overline{WAIT}$ 信号, 若从设备不能准备好数据, 则从设备主动给出 $\overline{WAIT}$ 信号. 已逐渐淘汰.
