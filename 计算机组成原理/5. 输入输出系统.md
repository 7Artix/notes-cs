
# 概述

输入输出系统的发展

**早期阶段**

I/O 设备种类少, I/O 设备与主存交换信息必须通过 CPU .

$$
\begin{array}{|c|}
\hline
主存\\
\hline
\end{array}
\iff
\begin{array}{|c|}
\hline
\text{CPU}\\
\hline
\end{array}
\iff
\begin{array}{|c|}
\hline
\text{I/O 设备}\\
\hline
\end{array}
$$

- 此时每个 I/O 设备都必须配有独立的逻辑电路与 CPU 相连, 用于实现 I/O 与主机的信息交换, 线路散乱复杂.
- 输入输出是在 CPU 执行程序过程之中进行的, I/O 与主机交换信息时, CPU 必须停止各种计算, I/O 与 CPU 是串行工作的, 效率极低.
- 每个 I/O 与 CPU 控制器是整体, 彼此依赖牵连, 因此增添, 删减, 更换 I/O 设备困难.

**接口模块与DMA阶段**

此时, I/O 通过接口与主机连接, 计算机系统采用了总线结构. I/O 设备通过接口挂载到总线上.
**接口**中有**数据通路**和**控制通路**, 通过接口, 数据可以起到缓冲. 
控制通路可以传送 CPU 发送给 I/O的控制命令, 使 CPU 接受来自 I/O 的反馈. 此外, 还可以实现中断请求, 提升 CPU 运行效率, 通过接口, I/O也可以实现分时占用总线.
另外, 出现了 <font color=red><b>DMA</b></font> Direct Memory Access. 在 I/O 和主存之间建立直接的数据通路, 使 I/O 可以直接和主存进行信息交换, 而不需要经过 CPU .

**具有通道结构的阶段**

$$
\begin{array}{|c|}
\hline
\text{CPU}\\
\hline
\end{array}
\iff
\begin{array}{|c|}
\hline
\text{主存}\\
\hline
\end{array}
\iff
\begin{array}{|c|c|}
\hline
\text{通道} & \text{I/O 设备}\\
\hline
\end{array}
$$

若每个 I/O 设备均配置专用的 DMA 接口, 在同时访问主存的时候会有冲突, 控制复杂.
DMA 同样需要 CPU 进行管理, 频繁的管理也会影响 CPU 效率.
引入**通道**负责管理 I/O 设备, 并负责主存与 I/O 设备之间信息交换. 
通道有专用的通道指令, 相当于专门负责输入输出的处理器, 通道通过部分替代 CPU 在 I/O 与主机交换信息时进行管理, 提升了 CPU 的工作效率.

**具有 I/O 处理机的阶段**

I/O 处理机又称外围处理机, 基本独立于主机工作, 相当于升级版的通道. I/O 处理机可以完成 I/O 控制, 也能进行码制变换, 格式处理, 数据纠错等工作. 有更高的独立性.


## I/O 系统组成

I/O 系统由 I/O 软件和 I/O 硬件两部分组成.

### I/O软件

I/O 软件主要功能为:
1. 将用户输入的程序和数据输入主机
2. 将运算结果输出给用户
3. 实现 I/O 系统于主机的工作协调

**I/O 指令**

I/O 指令是机器指令的一类. I/O 指令和其他指令字长相等. I/O 指令的一般格式为:

$$
\begin{array}{|c|c|}
\hline
\text{操作码} & \text{命令码} & \text{设备码} \\
\hline
\end{array}
$$

- 判别码: 作为 I/O 指令和其他指令 (访存, 算逻, 控制) 的判别.
- 命令码: 体现 I/O 指令的具体操作.
- 设备码: 进行多台 I/O 设备的选择.

命令码通常可以表述如下功能:
- 将数据从 I/O 输入至主机
- 将数据从主机输出至 I/O
- 状态测试
- 其余操作命令

**通道指令**

通道指令是针对有通道的 I/O 系统设计的指令. 指令通常包括:
- 主存首地址
- 传送字节数
- 所选设备码
- 操作命令码

通道指令是通道自身的指令, 而相对的 I/O 指令属于 CPU 指令系统. 
在具有通道的计算机中, I/O 指令不实现 I/O 数据传送, 而主要完成 I/O 启停, 通道控制等工作.
具有通道的计算机由通道代替 CPU 管理 I/O 设备.


### I/O 硬件

通道可以连接多个设备控制器, 设备控制器又可以控制若干同类设备.


##  I/O 与主机交互

**I/O 设备编址方式**

通常将 I/O 的设备码看做地址码, 采用 **统一编址** 或 **不统一编址**.

统一编址 (Memory-Mapped I/O, MMIO) 是将 I/O 看做存储器地址的一部分. 例如, 在 64K 地址的存储空间中, 划分 8K 作为 I/O 设备地址. 对于这 8K 范围内的地址的访问, 即对 I/O 的访问. **统一编址不需要专门的 I/O 指令**.

不统一编址 (Port-Mapped I/O, PMIO) 是 I/O 设备地址与存储器地址分开, 对所有 I/O 的访问, 必须有专门的 I/O 指令.

现代计算机系统采用**统一编址**, 即内存映射 I/O. 但 CPU 不会直接逐字节控制 I/O 设备, 通常由设备内控制器进行控制.

## I/O 与主机信息传输的控制方式

信息交换通常有 5 种控制方式:
- **程序查询方式**: I/O接口内设置一个反应就绪状态的标记, 在发起访问请求后, 轮询状态, 并在就绪后启动传输. CPU 在请求后被阻塞, 效率低.
- **程序中断方式**: CPU 在发起请求后继续工作, 由 I/O 主动向 CPU 发起中断请求. 需要对应的中断服务程序.
- **DMA存取方式**: 使用中断服务程序时, 需要记录现场, 另外在传输过程中, 仍需要 CPU 进行控制协调. 开发直接存储器存取方式.
- **I/O 通道方式**
- **I/O 处理机方式**


# I/O 设备

I/O 设备大致分为 3 类:
- 人机交互设备
- 信息存储设备
- 机机通信设备


# I/O 接口

I/O 接口指主机与 I/O 之间设置的硬件电路, 以及对应的软件控制.

接口 (Interface) 与端口 (Port) 不同, 端口是指接口电路中的一些寄存器, 这些寄存器分别用来存放数据信息, 控制信息和状态信息, 对应的端口分别为数据端口, 信息端口和状态端口, 端口是类似 Volatile 变量的概念.

I/O 设备通过 I/O 接口挂载到 I/O 总线上.
现代设备中, 主要是 PCI-Express 充当了 I/O 总线的角色. 另外还有 `CPU <=> 南桥` 总线, SATA 总线, USB 总线, Thunderbolt 总线.

I/O 总线由包括了数据线, 设备选择线, 命令线和状态线. 实际在 PCIe 总线中, 数据是打包的, 是高度抽象和分层的.

现代结构的实际过程是 CPU 发起需求, CPU 本身不会直接接触 I/O 设备, 一切通过 I/O 设备上的**设备控制器**完成. 
由于现代 I/O 大多通过PCIe连接, CPU 上会有一个 Root Complex (RC), 作为 PCIe 拓扑结构的起点和核心, 是总线的主端口.
CPU 通过写设备控制器的寄存器, 提出任务要求, 包括控制, 传输, 状态查询等.

I/O 接口具有如下功能, 以及对应的硬件配置:
1. **选址功能**: 响应主机发出的设备选择.
2. **传送命令功能**
3. **数据传输功能**
4. **I/O 状态反馈功能**
5. **中断请求触发功能**


# 程序查询方式

程序查询是主机控制 I/O 进行数据交换的方式之一, 是在发起请求后, 轮询 I/O 状态的方式.
当有多个 I/O 设备时, 主机需要按 I/O 的优先级进行轮询, 对应如下指令:
1. 测试指令: 判断 I/O 是否准备就绪
2. 传送指令: 当 I/O 就绪时, 执行传送.
3. 转移指令: 当 I/O 未就绪时, 执行转移指令, 转至测试指令, 继续测试.


# 程序中断方式

<font color=red><b>中断</b></font>: 当出现异常状况, 或某种请求时, CPU 停止当前程序的运行, 转而对请求或状况进行处理, 处理后返回程序间断处继续执行.

由于 I/O 运行速度与 CPU 速度差距大, 因此通过中断的形式协调二者的工作. 
另外, 中断还可以用作异常处理, 或作为实时系统中的控制操作使用.

为了实现中断, I/O 接口中有对应的硬件线路:
- 中断请求触发器: I/O 准备就绪后, 向 CPU 提出中断请求.
- 中断屏蔽触发器: 当多个中断同时提出时, 接受最高优先级中断请求, 屏蔽其余请求.
- 排队器: 对多个中断进行优先级排序.
- 中断向量地址形成部件: 中断响应后, CPU 寻找对应的中断服务程序入口.

当 CPU 中的允许中断触发器为 1 时, CPU 可以响应 I/O 中断请求.
CPU 在统一时刻向所有 I/O 接口发送中断查询信号, 获取中断请求. 因此, CPU 响应中断的时间是固定的, 如每条指令执行阶段的结束时刻.

一次中断的处理过程为:
1. 中断请求
2. 中断判优
3. 中断响应
4. 中断服务
5. 中断返回

**中断响应**主要为硬件工作: 阻止更低优先级中断, 保存现场 (部分), 识别中断源, 产生中断向量号.
**中断服务**主要为软件工作: 保存现场 (完整), 处理任务, 清除中断, 恢复现场, 返回执行.

中断响应中保存的现场主要为 PC (Program Counter, 程序计数器) 和 PSW (Program Status Word, 程序状态字).

中断服务中保存的现场是完整的, 包括所有通用寄存器, 如数据寄存器, 地址寄存器到内核栈.


# DMA 方式

DMA 不需要 CPU 暂停现行程序为设备服务, 省去了保护和恢复现场, 特别适用于高速 I/O 以及主存与辅存间数据交换.

若 CPU 和 DMA 同时访问主存, 则 CPU 会将总线所有权让与 DMA. 二者会经过总线仲裁分时访问主存.

为了有效协调 CPU 和 DMA 对主存的访问, 有如下 3 种方案:
1. 停止 CPU 访问主存
   当外设传送数据时, DMA 接口向 CPU 发出停止信号, 要求 CPU 放弃总线使用权. 在 DMA 传送完毕后, 通知 CPU 恢复访问主存.
   缺点是 CPU 对主存的访问被耽搁, 可能首先于 I/O 的读取速度. 通常在 DMA 中设置 Buffer, 减少占用时间.
2. 周期挪用 (周期窃取)
   适用于低速零星的数据传输, DMA 会只请求传输 1 个数据字节或字, 等待 CPU 不占用总线时, 完成访存.
3. DMA/CPU 交替访问
   是现代 DMA 传输的标准做法, DMA 会在获得总线使用权后进入 Burst Mode. CPU会短暂阻塞, 直到 DMA 传输完成, 或达到预设上限.

另外有仲裁机制, 确保二者不会同时访存, 并给予合适的访问权.

DMA 由如下几个部分**组成**:
- 主存地址寄存器 (AR) : 存储主存中需要交换数据的地址
- 字计数器 (WC) : 传输数据的总字数
- 数据缓冲寄存器 (BR) : 寄存每次传送的数据
- DMA 逻辑控制器: 控制传送过程, 由控制电路, 时序电路, 命令状态控制寄存器构成
- 中断机构: 向 CPU 发起中断请求, 表示传输结束
- 设备地址寄存器 (DAR) : 存放 I/O 设备的设备码, 或表示设备信息存储区

DMA 的工作过程为:
1. 预处理: CPU 向 DMA 提供信息:
	- 数据传送方向: 输入 / 输出
	- I/O 设备号
	- 主存起始地址
	- 字数
2. 数据传送: DMA 以数据块为单位传送数据
3. 后处理: DMA 向 CPU 提起中断请求, CPU 进行一些后处理, 如数据校验, 是否继续传输等.

